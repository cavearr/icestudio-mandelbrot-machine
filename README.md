# Mandelbrot Machine @ Alhambra II

This project is an adaptation and evolution of the original **Mandelbrot Machine** by *Jes√∫s Arias* (designed for his SIMRETRO board).

The goal of the project was to create a version of the design that, without modifying the original core, could run on the **Alhambra II** board (Lattice iCE40HX4K), which has fewer resources than the SIMRETRO board.

This exercise served as a first test of a methodology based on small ‚Äúemulator‚Äù modules for hardware peripherals that ‚Äútrick‚Äù the original core, allowing the design to run even when the hardware resources differ, and adapting native capabilities to the requirements of the original design.

In this sense, the project has been a success. The visual experience‚Äîalthough different from the original‚Äîis very satisfying, as is the user interface through a generic, low-cost joystick.


## üöÄ Highlighted Features

  * **Hybrid Visualization Architecture:**
      * **Background:** Spatially compressed rendering (4:1) to fit inside BRAM.
      * **‚ÄúMagnifier‚Äù Window (192x100):** High-resolution uncompressed area overlaid on the background, allowing the true mathematical detail of the fractal to be seen.
  * **SRAM Emulation Using BRAMs:** Since the original core expects an SRAM memory, a BRAM memory behaving like video-oriented SRAM was created.
  * **Unmodified Math Core:** Uses the original core by J. Arias with Q4.11 and Q5.18 fixed-point multipliers.
  * **Advanced Analog Control:** Navigation with a joystick featuring IIR digital filtering, hysteresis, and auto-calibration.
  * **Adapted Video Output:** RGB444-to-RGB222 (6-bit) color conversion compatible with simple R-2R DACs.
  * **Video Pipeline:** Spatial smoothing (3√ó3 convolution filter) and dynamic memory mapping.

## üéÆ Control Interface

The system is controlled using a standard analog joystick (Arduino-style KY-023) connected through an I2C ADC.

| Control | Action | Description |
| :--- | :--- | :--- |
| **Joystick (X/Y Axes)** | Move Magnifier | Moves the detail window over the fractal. |
| **Button SW1 (A)** | Vertical Magnifier Mode | Allows free vertical movement of the magnifier without shifting the background fractal. |
| **Button SW2 (B)** | **Zoom Mode** | Hold + move Joystick Up/Down to perform Zoom In/Out. |

## üîå Hardware Connections

### 1. Video Output (6-bit VGA)

A VGA adapter with an R-2R DAC is required (such as [AP-VGA](https://github.com/Alhambra-bits/AP-VGA) or a homemade one).

  * **Output level:** ~0.41V (60% brightness due to internal FPGA resistances).

| VGA Signal | FPGA Pin | Description |
| :--- | :--- | :--- |
| **RED** (MSB/LSB) | D7 / D6 | 470Œ© / 1kŒ© resistors |
| **GREEN** (MSB/LSB) | D5 / D4 | 470Œ© / 1kŒ© resistors |
| **BLUE** (MSB/LSB) | D3 / D2 | 470Œ© / 1kŒ© resistors |
| **HSYNC** | D1 | 100Œ© resistor |
| **VSYNC** | D0 | 100Œ© resistor |
| **GND** | GND | Ground |

### 2. Control Input (Joystick)

An **ADS7924** (12-bit I2C) ADC is used to read the potentiometers.  
The ADC is already integrated in the Alhambra-II board.

| Joystick KY-023 | Connection | Notes |
| :--- | :--- | :--- |
| **VRx** | ADC Channel 0 | X axis | Alhambra pin A0 |
| **VRy** | ADC Channel 1 | Y axis | Alhambra pin A1 |
| **SW1** (Button A) | FPGA GPIO | Activates zoom when held |
| **SW2** (Button B) | FPGA GPIO | Free magnifier movement when held |

## üìÇ Project Structure

  * **`mandelbrot_top.ice`**: Main Icestudio project (block diagram).
  * **`verilog files (.v)`**: Source code of the various modules.
  * **`docs/`**: Contains the detailed technical manual **`mandelbrotmachine-alh.pdf`**.
  * **`bitstreams/`**: Ready-to-flash bitstreams without needing to synthesize.
  * **`generated_code/`**: Code generated by Icestudio in case the reader wants to synthesize it directly with Yosys.

## ‚öôÔ∏è Configuration and Synthesis

The project is designed to be synthesized using the open-source toolchain (Yosys, Nextpnr, Icestudio).

The design occupies almost the entire FPGA (over 95% utilization). Synthesis time is typically around one minute.


## References
* Jes√∫s Arias, Mandelbrot Machine: [Documentation](https://www.ele.uva.es/~jesus/SIMRETRO/mandelmachine.pdf) and [Code](https://www.ele.uva.es/~jesus/BAC.tgz)
* AP-VGA: (https://github.com/Alhambra-bits/AP-VGA)
* Alhambra-II Board: (https://github.com/FPGAwars/Alhambra-II-FPGA)
* Icestudio: [Project Website](https://icestudio.io)

## ¬© Credits and License

  * **Alhambra II adaptation, Video Pipeline, Control, and Booth fixed-point multiplier:** Carlos Venegas (@cavearr).
  * **Original Design and Math Core:** Jes√∫s Arias (University of Valladolid) [Website](https://www.ele.uva.es/~jesus/)
  * **I2C ADC and Encoder Adaptation:** @Dem√≥crito [GitHub Page](https://github.com/democrito)

### License

  * Newly created modules (*Carlos Venegas*) are released into the **Public Domain (CC0 1.0)**  
    [License link](https://creativecommons.org/publicdomain/zero/1.0/) ‚Äî also included in **LICENSE.txt**.
  * The original core (*Jes√∫s Arias*) is used with permission for educational/open-source purposes (see file headers), preserving its original license.

-----

*Dedicated to the FPGAwars community*


